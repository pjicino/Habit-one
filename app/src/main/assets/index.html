<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>æ¯æ—¥çº åæ‰‹å†Œ</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f0f0f;
    --surface: #181818;
    --surface2: #222222;
    --border: #2a2a2a;
    --text: #e8e4dc;
    --text-dim: #7a7570;
    --green: #4caf78;
    --yellow: #d4a843;
    --red: #c05a4a;
    --accent: #8b7355;
    --accent-light: #c4a882;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Noto Serif SC', serif;
    min-height: 100vh;
    padding: 0 0 80px 0;
  }

  /* Header */
  .header {
    padding: 40px 24px 24px;
    border-bottom: 1px solid var(--border);
    position: relative;
    overflow: hidden;
  }
  .header::before {
    content: '';
    position: absolute;
    top: -60px; right: -40px;
    width: 200px; height: 200px;
    background: radial-gradient(circle, rgba(139,115,85,0.15) 0%, transparent 70%);
    pointer-events: none;
  }
  .date-label {
    font-family: 'Space Mono', monospace;
    font-size: 11px;
    color: var(--text-dim);
    letter-spacing: 2px;
    text-transform: uppercase;
    margin-bottom: 8px;
  }
  #today-date {
    font-size: 13px;
    color: var(--accent-light);
    font-family: 'Space Mono', monospace;
  }
  .title {
    font-size: 28px;
    font-weight: 300;
    letter-spacing: 2px;
    color: var(--text);
    line-height: 1.3;
  }
  .subtitle {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-dim);
    font-weight: 300;
  }

  /* Tabs */
  .tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    padding: 0 24px;
    gap: 0;
    overflow-x: auto;
    scrollbar-width: none;
  }
  .tabs::-webkit-scrollbar { display: none; }
  .tab {
    padding: 16px 16px;
    font-size: 12px;
    letter-spacing: 1.5px;
    color: var(--text-dim);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    white-space: nowrap;
    transition: all 0.2s;
    font-family: 'Space Mono', monospace;
  }
  .tab.active {
    color: var(--accent-light);
    border-bottom-color: var(--accent-light);
  }

  /* Panels */
  .panel { display: none; padding: 24px; }
  .panel.active { display: block; }

  /* Section */
  .section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 16px;
  }
  .section-title {
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    letter-spacing: 2px;
    text-transform: uppercase;
    color: var(--accent);
    margin-bottom: 16px;
  }

  /* Traffic Light */
  .traffic-light {
    display: flex;
    gap: 12px;
    justify-content: center;
    margin: 8px 0;
  }
  .light-btn {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    border: 2px solid transparent;
    cursor: pointer;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 4px;
    transition: all 0.2s;
    background: var(--surface2);
    font-size: 24px;
  }
  .light-btn span {
    font-size: 10px;
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
  }
  .light-btn.green { border-color: var(--green); }
  .light-btn.yellow { border-color: var(--yellow); }
  .light-btn.red { border-color: var(--red); }
  .light-btn.selected.green { background: rgba(76,175,120,0.2); }
  .light-btn.selected.yellow { background: rgba(212,168,67,0.2); }
  .light-btn.selected.red { background: rgba(192,90,74,0.2); }

  /* Micro steps */
  .step-item {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 0;
    border-bottom: 1px solid var(--border);
    cursor: pointer;
  }
  .step-item:last-child { border-bottom: none; }
  .step-check {
    width: 28px; height: 28px;
    border-radius: 50%;
    border: 1.5px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
    transition: all 0.2s;
    font-size: 14px;
  }
  .step-check.done {
    background: var(--green);
    border-color: var(--green);
  }
  .step-text { flex: 1; }
  .step-name {
    font-size: 15px;
    font-weight: 300;
    color: var(--text);
    line-height: 1.4;
  }
  .step-desc {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 3px;
    font-family: 'Space Mono', monospace;
  }

  /* State word input */
  .state-input {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 14px;
    color: var(--text);
    font-family: 'Noto Serif SC', serif;
    font-size: 15px;
    resize: none;
    outline: none;
    transition: border-color 0.2s;
  }
  .state-input:focus { border-color: var(--accent); }
  .state-input::placeholder { color: var(--text-dim); }

  /* Alert box */
  .alert-box {
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 16px;
    border: 1px solid;
    font-size: 13px;
    line-height: 1.6;
  }
  .alert-box.yellow {
    background: rgba(212,168,67,0.08);
    border-color: rgba(212,168,67,0.3);
    color: var(--yellow);
  }
  .alert-box.red {
    background: rgba(192,90,74,0.08);
    border-color: rgba(192,90,74,0.3);
    color: var(--red);
  }
  .alert-box.green {
    background: rgba(76,175,120,0.08);
    border-color: rgba(76,175,120,0.3);
    color: var(--green);
  }

  /* History dots */
  .history-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-top: 8px;
  }
  .history-dot {
    width: 32px; height: 32px;
    border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 16px;
    background: var(--surface2);
    border: 1px solid var(--border);
    position: relative;
    cursor: pointer;
  }
  .history-dot .dot-date {
    position: absolute;
    bottom: -18px;
    font-size: 9px;
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
    white-space: nowrap;
  }
  .history-wrap {
    padding-bottom: 24px;
  }

  /* Progress bar */
  .progress-bar {
    height: 4px;
    background: var(--surface2);
    border-radius: 2px;
    overflow: hidden;
    margin-top: 12px;
  }
  .progress-fill {
    height: 100%;
    background: var(--green);
    border-radius: 2px;
    transition: width 0.4s ease;
  }
  .progress-label {
    display: flex;
    justify-content: space-between;
    margin-top: 6px;
    font-family: 'Space Mono', monospace;
    font-size: 10px;
    color: var(--text-dim);
  }

  /* Review form */
  .form-label {
    font-size: 12px;
    color: var(--accent-light);
    font-family: 'Space Mono', monospace;
    letter-spacing: 1px;
    margin-bottom: 8px;
    display: block;
  }
  .score-row {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .score-btn {
    flex: 1;
    height: 40px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-dim);
    font-family: 'Space Mono', monospace;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .score-btn.selected {
    background: var(--accent);
    border-color: var(--accent);
    color: var(--bg);
  }
  .checkbox-row {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-bottom: 16px;
  }
  .choice-btn {
    padding: 8px 14px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 20px;
    color: var(--text-dim);
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s;
  }
  .choice-btn.selected {
    background: rgba(139,115,85,0.3);
    border-color: var(--accent);
    color: var(--accent-light);
  }

  /* Button */
  .btn {
    width: 100%;
    padding: 16px;
    background: var(--accent);
    border: none;
    border-radius: 10px;
    color: var(--bg);
    font-family: 'Space Mono', monospace;
    font-size: 13px;
    letter-spacing: 1px;
    cursor: pointer;
    transition: opacity 0.2s;
    margin-top: 8px;
  }
  .btn:active { opacity: 0.8; }
  .btn.secondary {
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent-light);
  }

  /* Divider */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 20px 0;
  }

  /* Return ritual */
  .return-box {
    background: linear-gradient(135deg, rgba(139,115,85,0.15), rgba(76,175,120,0.08));
    border: 1px solid rgba(139,115,85,0.3);
    border-radius: 12px;
    padding: 20px;
    text-align: center;
    margin-bottom: 16px;
  }
  .return-box .big-emoji { font-size: 40px; margin-bottom: 12px; }
  .return-box p { font-size: 14px; color: var(--text-dim); line-height: 1.7; }
  .return-box strong { color: var(--accent-light); }

  /* Notification reminder */
  .reminder-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 16px;
    margin-bottom: 12px;
    display: flex;
    align-items: center;
    gap: 14px;
  }
  .reminder-time {
    font-family: 'Space Mono', monospace;
    font-size: 20px;
    color: var(--accent-light);
    min-width: 60px;
  }
  .reminder-text { font-size: 13px; color: var(--text-dim); line-height: 1.5; }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 90px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: var(--surface2);
    border: 1px solid var(--accent);
    color: var(--accent-light);
    padding: 12px 20px;
    border-radius: 20px;
    font-size: 13px;
    font-family: 'Space Mono', monospace;
    opacity: 0;
    transition: all 0.3s;
    white-space: nowrap;
    z-index: 100;
  }
  .toast.show {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  /* Stat cards */
  .stats-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 10px;
    margin-bottom: 16px;
  }
  .stat-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 14px 10px;
    text-align: center;
  }
  .stat-num {
    font-family: 'Space Mono', monospace;
    font-size: 24px;
    color: var(--text);
    line-height: 1;
  }
  .stat-label {
    font-size: 10px;
    color: var(--text-dim);
    margin-top: 4px;
    letter-spacing: 1px;
  }
  .stat-card.green .stat-num { color: var(--green); }
  .stat-card.yellow .stat-num { color: var(--yellow); }
  .stat-card.red .stat-num { color: var(--red); }
</style>
</head>
<body>

<div class="header">
  <div class="date-label">æ¯æ—¥çº åæ‰‹å†Œ &nbsp;Â·&nbsp; <span id="today-date"></span></div>
  <div class="title">åŠ¨æ€åŸºå‡†<br>çº åç³»ç»Ÿ</div>
  <div class="subtitle">è§‰å¯Ÿ Â· å›æ¥ Â· ç»§ç»­</div>
</div>

<div class="tabs">
  <div class="tab active" onclick="switchTab('daily')">æ¯æ—¥</div>
  <div class="tab" onclick="switchTab('signal')">ä¿¡å·</div>
  <div class="tab" onclick="switchTab('review')">çº å</div>
  <div class="tab" onclick="switchTab('return')">å›æ¥</div>
  <div class="tab" onclick="switchTab('history')">è®°å½•</div>
</div>

<!-- æ¯æ—¥é¢æ¿ -->
<div class="panel active" id="panel-daily">

  <div class="section">
    <div class="section-title">ä»Šæ—¥çº¢ç»¿ç¯</div>
    <div class="traffic-light">
      <div class="light-btn green" onclick="selectLight('green', this)">
        ğŸŸ¢<span>æ­£å¸¸</span>
      </div>
      <div class="light-btn yellow" onclick="selectLight('yellow', this)">
        ğŸŸ¡<span>åç§»</span>
      </div>
      <div class="light-btn red" onclick="selectLight('red', this)">
        ğŸ”´<span>èµ°å</span>
      </div>
    </div>
    <div id="light-hint" style="text-align:center;margin-top:12px;font-size:12px;color:var(--text-dim);min-height:18px;"></div>
  </div>

  <div class="section">
    <div class="section-title">ä¸‰å±‚æœ€å°åŠ¨ä½œ</div>

    <div class="step-item" onclick="toggleStep('step1', this)">
      <div class="step-check" id="step1">ã€€</div>
      <div class="step-text">
        <div class="step-name">æ…¢å‘¼æ°” 3 æ¬¡</div>
        <div class="step-desc">å¸4ç§’ Â· å‘¼6ç§’ Â· èº«ä½“å¤ä½</div>
      </div>
    </div>

    <div class="step-item" onclick="toggleStep('step2', this)">
      <div class="step-check" id="step2">ã€€</div>
      <div class="step-text">
        <div class="step-name">è¯´ä¸€ä¸ªçŠ¶æ€è¯</div>
        <div class="step-desc">æ­¤åˆ»æ„Ÿè§‰æ€æ ·ï¼Ÿä¸€ä¸ªè¯å³å¯</div>
      </div>
    </div>

    <div class="step-item" onclick="toggleStep('step3', this)">
      <div class="step-check" id="step3">ã€€</div>
      <div class="step-text">
        <div class="step-name">å†™ä¸‹ä»Šæ—¥æœ€å°ä¸€æ­¥</div>
        <div class="step-desc">ä¸€ä»¶äº‹ Â· ä¸€å¥è¯ Â· å®Œæˆ</div>
      </div>
    </div>

    <div class="progress-bar">
      <div class="progress-fill" id="step-progress" style="width:0%"></div>
    </div>
    <div class="progress-label">
      <span>å®Œæˆè¿›åº¦</span>
      <span id="step-count">0 / 3</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">ä»Šæ—¥è®°å½•</div>
    <label class="form-label">çŠ¶æ€è¯</label>
    <textarea class="state-input" id="state-word" rows="1" placeholder="æ­¤åˆ»ä¸€ä¸ªè¯æè¿°ä½ çš„çŠ¶æ€â€¦"></textarea>
    <div style="margin-top:12px;">
      <label class="form-label">ä»Šæ—¥æœ€å°ä¸€æ­¥</label>
      <textarea class="state-input" id="min-step" rows="2" placeholder="ä»Šå¤©æˆ‘è¦åšçš„æœ€å°ä¸€æ­¥æ˜¯â€¦"></textarea>
    </div>
    <button class="btn" onclick="saveDailyRecord()" style="margin-top:16px;">ä¿å­˜ä»Šæ—¥è®°å½•</button>
  </div>

  <div id="trigger-alert"></div>

</div>

<!-- ä¿¡å·é¢æ¿ -->
<div class="panel" id="panel-signal">

  <div class="section">
    <div class="section-title">è§¦å‘æ¡ä»¶è¯´æ˜</div>
    <div class="alert-box yellow">
      <strong>ğŸŸ¡ è½»é‡çº åè§¦å‘</strong><br>
      è¿ç»­å‡ºç° 2 ä¸ªé»„ç¯<br>
      â†’ é—®è‡ªå·±ï¼š"æœ€è¿‘å“ªé‡Œæ„Ÿè§‰åœ¨èµ°å½¢å¼ï¼Ÿ"<br>
      å†™ä¸€å¥è¯ï¼Œè°ƒæ•´ä¸€ä¸ªç»†èŠ‚ã€‚
    </div>
    <div class="alert-box red">
      <strong>ğŸ”´ å®Œæ•´çº åè§¦å‘</strong><br>
      å‡ºç° 1 ä¸ªçº¢ç¯ï¼Œæˆ–è¿ç»­ 3 ä¸ªé»„ç¯<br>
      â†’ æ‰“å¼€ã€Œçº åã€æ ‡ç­¾ï¼Œå®Œæˆå›é¡¾è¡¨å•ã€‚
    </div>
    <div class="alert-box green">
      <strong>ğŸŸ¢ å‘¨æœŸæ ¡å‡†è§¦å‘</strong><br>
      ç§¯ç´¯ 14 ä¸ªç»¿ç¯ï¼ˆä¸éœ€è¿ç»­ï¼‰<br>
      â†’ åšä¸€æ¬¡æœˆåº¦æ ¡å‡†ï¼Œé—®ä¸‰ä¸ªé—®é¢˜ã€‚
    </div>
  </div>

  <div class="section">
    <div class="section-title">å½“å‰ä¿¡å·çŠ¶æ€</div>
    <div class="stats-row">
      <div class="stat-card green">
        <div class="stat-num" id="stat-green">0</div>
        <div class="stat-label">ç»¿ç¯ç´¯è®¡</div>
      </div>
      <div class="stat-card yellow">
        <div class="stat-num" id="stat-yellow">0</div>
        <div class="stat-label">è¿‘æœŸé»„ç¯</div>
      </div>
      <div class="stat-card red">
        <div class="stat-num" id="stat-red">0</div>
        <div class="stat-label">è¿‘æœŸçº¢ç¯</div>
      </div>
    </div>

    <div id="current-signal-status"></div>

    <div class="progress-bar" style="margin-top:4px;">
      <div class="progress-fill" id="green-progress" style="width:0%;background:var(--green)"></div>
    </div>
    <div class="progress-label">
      <span>ç»¿ç¯å‘¨æœŸè¿›åº¦</span>
      <span id="green-count">0 / 14</span>
    </div>
  </div>

  <div class="section">
    <div class="section-title">æé†’è®¾ç½®å»ºè®®</div>
    <div class="reminder-card">
      <div class="reminder-time">21:00</div>
      <div class="reminder-text">æ™šé—´æ‰“å¡æé†’<br>"ä»Šå¤©æ˜¯ğŸŸ¢ğŸŸ¡ğŸ”´ï¼Ÿ"</div>
    </div>
    <div class="reminder-card">
      <div class="reminder-time">å‘¨æ—¥</div>
      <div class="reminder-text">æ¯å‘¨ä¿¡å·å›é¡¾<br>"æœ¬å‘¨æœ‰å‡ ä¸ªé»„å’Œçº¢ï¼Ÿ"</div>
    </div>
    <p style="font-size:12px;color:var(--text-dim);margin-top:8px;line-height:1.6;">
      è¯·åœ¨æ‰‹æœºã€Œæé†’äº‹é¡¹ã€æˆ–ã€Œæ—¥å†ã€ä¸­æ‰‹åŠ¨è®¾ç½®ä»¥ä¸Šä¸¤ä¸ªé‡å¤æé†’ã€‚
    </p>
  </div>

</div>

<!-- çº åé¢æ¿ -->
<div class="panel" id="panel-review">

  <div class="section">
    <div class="section-title">çº åå›é¡¾è¡¨å•</div>
    <p style="font-size:13px;color:var(--text-dim);margin-bottom:16px;line-height:1.6;">
      è§¦å‘æ¡ä»¶æ»¡è¶³åä½¿ç”¨ã€‚è¯šå®ä½œç­”ï¼Œä¸éœ€è¦å®Œç¾ã€‚
    </p>

    <label class="form-label">ã€èº«ä½“å±‚ã€‘æœ€è¿‘ç¡çœ å’Œç–²åŠ³æ„Ÿ</label>
    <div class="score-row" id="score-sleep">
      <button class="score-btn" onclick="selectScore('sleep',1,this)">1</button>
      <button class="score-btn" onclick="selectScore('sleep',2,this)">2</button>
      <button class="score-btn" onclick="selectScore('sleep',3,this)">3</button>
      <button class="score-btn" onclick="selectScore('sleep',4,this)">4</button>
      <button class="score-btn" onclick="selectScore('sleep',5,this)">5</button>
    </div>

    <label class="form-label">è‡ªå¾‹ç¥ç»è°ƒèŠ‚æœ€è¿‘åœ¨åšå—ï¼Ÿ</label>
    <div class="checkbox-row" id="ans-nerve">
      <div class="choice-btn" onclick="toggleChoice(this)">æœ‰åœ¨åš</div>
      <div class="choice-btn" onclick="toggleChoice(this)">å¶å°”åš</div>
      <div class="choice-btn" onclick="toggleChoice(this)">å‡ ä¹æ²¡åš</div>
    </div>

    <div class="divider"></div>

    <label class="form-label">ã€è§‰å¯Ÿå±‚ã€‘æœ€è¿‘æ´»åœ¨å½“ä¸‹çš„æ—¶åˆ»</label>
    <div class="checkbox-row" id="ans-present">
      <div class="choice-btn" onclick="toggleChoice(this)">æœ‰å‡ ä¸ªç‰‡æ®µ</div>
      <div class="choice-btn" onclick="toggleChoice(this)">å¾ˆéš¾å¯Ÿè§‰</div>
      <div class="choice-btn" onclick="toggleChoice(this)">å¤§å¤šè‡ªåŠ¨é©¾é©¶</div>
    </div>

    <div class="divider"></div>

    <label class="form-label">ã€ä¹ æƒ¯å±‚ã€‘ä¸‰ä¸ªæœ€å°åŠ¨ä½œå®Œæˆç‡</label>
    <div class="score-row" id="score-habit">
      <button class="score-btn" onclick="selectScore('habit',1,this)">ä½</button>
      <button class="score-btn" onclick="selectScore('habit',2,this)">ä¸€èˆ¬</button>
      <button class="score-btn" onclick="selectScore('habit',3,this)">è¿˜å¥½</button>
      <button class="score-btn" onclick="selectScore('habit',4,this)">é«˜</button>
    </div>

    <label class="form-label">æœ€å®¹æ˜“è¢«è·³è¿‡çš„æ­¥éª¤</label>
    <div class="checkbox-row" id="ans-skip">
      <div class="choice-btn" onclick="toggleChoice(this)">å‘¼å¸å¤ä½</div>
      <div class="choice-btn" onclick="toggleChoice(this)">çŠ¶æ€è§‰å¯Ÿ</div>
      <div class="choice-btn" onclick="toggleChoice(this)">è§„åˆ’æœ€å°æ­¥</div>
    </div>

    <div class="divider"></div>

    <label class="form-label">ç°åœ¨æˆ‘éœ€è¦çš„æ˜¯</label>
    <div class="checkbox-row" id="ans-need">
      <div class="choice-btn" onclick="toggleChoice(this)">ä¼‘æ¯</div>
      <div class="choice-btn" onclick="toggleChoice(this)">é‡æ–°å¼€å§‹</div>
      <div class="choice-btn" onclick="toggleChoice(this)">å¾®è°ƒæµç¨‹</div>
    </div>

    <label class="form-label" style="margin-top:8px;">ä»Šå¤©çš„æœ€å°ä¸€æ­¥</label>
    <textarea class="state-input" id="review-step" rows="2" placeholder="å†™ä¸‹æ¥â€¦"></textarea>

    <button class="btn" onclick="saveReview()">å®Œæˆçº åè®°å½•</button>
  </div>

</div>

<!-- å›æ¥é¢æ¿ -->
<div class="panel" id="panel-return">

  <div class="return-box">
    <div class="big-emoji">ğŸŒ¬ï¸</div>
    <p>èµ°åä¹‹åçš„å›æ¥åŠ¨ä½œåªæœ‰ä¸€ä¸ªï¼š<br><br>
    <strong>åšä¸€æ¬¡æ…¢å‘¼æ°”ï¼Œç„¶åæ‰“ä¸€ä¸ªğŸŸ¢ã€‚</strong><br><br>
    ä¸éœ€è¦è¡¥å›æ¥ï¼Œä¸éœ€è¦åçœï¼Œä¸éœ€è¦é‡æ–°èµ°å®Œä¸‰å±‚ã€‚<br>
    ä¸€æ¬¡å‘¼å¸å°±æ˜¯é‡æ–°å¼€å§‹ã€‚</p>
  </div>

  <div class="section">
    <div class="section-title">ç°åœ¨å°±å›æ¥</div>
    <p style="font-size:14px;color:var(--text-dim);margin-bottom:20px;line-height:1.7;">
      è·Ÿç€èŠ‚æ‹åšä¸€æ¬¡å‘¼å¸ï¼š
    </p>
    <div id="breath-display" style="text-align:center;padding:20px 0;">
      <div id="breath-circle" style="
        width:100px;height:100px;
        border-radius:50%;
        border:2px solid var(--accent);
        margin:0 auto 16px;
        display:flex;align-items:center;justify-content:center;
        font-size:13px;color:var(--accent-light);
        font-family:'Space Mono',monospace;
        transition:all 0.5s ease;
      ">å‡†å¤‡</div>
      <div id="breath-text" style="font-size:13px;color:var(--text-dim);font-family:'Space Mono',monospace;min-height:20px;"></div>
    </div>
    <button class="btn" id="breath-btn" onclick="startBreath()">å¼€å§‹å‘¼å¸å¼•å¯¼</button>
  </div>

  <div class="section">
    <div class="section-title">æœˆåº¦ä¸‰é—®ï¼ˆ14ç»¿ç¯åï¼‰</div>
    <div style="font-size:14px;color:var(--text);line-height:2;">
      1. è¿™å¥—æµç¨‹è¿˜é€‚åˆæˆ‘å—ï¼Ÿ<br>
      2. æœ‰ä»€ä¹ˆå¯ä»¥æ›´ç®€åŒ–çš„ï¼Ÿ<br>
      3. ä¸‹ä¸€ä¸ªå‘¨æœŸæˆ‘æƒ³å¾®è°ƒä»€ä¹ˆï¼Ÿ
    </div>
    <textarea class="state-input" id="monthly-review" rows="4" placeholder="å†™ä¸‹ä½ çš„å›ç­”â€¦" style="margin-top:16px;"></textarea>
    <button class="btn secondary" onclick="saveMonthly()" style="margin-top:12px;">ä¿å­˜æœˆåº¦æ ¡å‡†</button>
  </div>

</div>

<!-- è®°å½•é¢æ¿ -->
<div class="panel" id="panel-history">

  <div class="section">
    <div class="section-title">çº¢ç»¿ç¯å†å²</div>
    <div class="history-wrap">
      <div class="history-grid" id="history-grid">
        <p style="font-size:13px;color:var(--text-dim);">å¼€å§‹æ¯æ—¥æ‰“å¡åï¼Œå†å²è®°å½•ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>
      </div>
    </div>
  </div>

  <div class="section">
    <div class="section-title">çŠ¶æ€è¯è®°å½•</div>
    <div id="state-history" style="font-size:13px;color:var(--text-dim);line-height:2;">
      æš‚æ— è®°å½•
    </div>
  </div>

  <div class="section">
    <div class="section-title">çº åè®°å½•</div>
    <div id="review-history" style="font-size:13px;color:var(--text-dim);line-height:1.8;">
      æš‚æ— çº åè®°å½•
    </div>
  </div>

  <button class="btn secondary" onclick="clearAll()" style="margin-top:8px;border-color:var(--red);color:var(--red);">æ¸…é™¤æ‰€æœ‰è®°å½•</button>

</div>

<div class="toast" id="toast"></div>

<script>
// State
let data = JSON.parse(localStorage.getItem('habit_data') || '{}');
if (!data.lights) data.lights = [];
if (!data.records) data.records = [];
if (!data.reviews) data.reviews = [];

function save() {
  localStorage.setItem('habit_data', JSON.stringify(data));
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

// Date
const today = new Date();
const dateStr = today.toLocaleDateString('zh-CN', {year:'numeric',month:'long',day:'numeric',weekday:'short'});
document.getElementById('today-date').textContent = dateStr;
const todayKey = today.toISOString().slice(0,10);

// Tabs
function switchTab(name) {
  document.querySelectorAll('.tab').forEach((t,i) => {
    const names = ['daily','signal','review','return','history'];
    t.classList.toggle('active', names[i] === name);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-'+name).classList.add('active');
  if (name === 'signal') updateSignal();
  if (name === 'history') renderHistory();
}

// Traffic light
let selectedLight = null;
function selectLight(color, el) {
  document.querySelectorAll('.light-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
  selectedLight = color;
  const hints = {
    green: 'çŠ¶æ€ä¸é”™ï¼Œæµç¨‹æ­£å¸¸è¿›è¡Œ âœ“',
    yellow: 'æ„Ÿè§‰æœ‰ç‚¹åï¼Œæ³¨æ„è§‚å¯Ÿè¿ç»­æƒ…å†µ',
    red: 'æ˜æ˜¾èµ°åï¼Œå»ºè®®æ‰“å¼€ã€Œçº åã€æ ‡ç­¾'
  };
  document.getElementById('light-hint').textContent = hints[color];
  checkTrigger();
}

function checkTrigger() {
  const recent = data.lights.slice(-5);
  const alertEl = document.getElementById('trigger-alert');
  let html = '';

  // Check consecutive yellows
  let consecYellow = 0;
  for (let i = data.lights.length - 1; i >= 0; i--) {
    if (data.lights[i].color === 'yellow') consecYellow++;
    else break;
  }
  if (selectedLight === 'yellow') consecYellow++;

  if (selectedLight === 'red' || consecYellow >= 3) {
    html = '<div class="alert-box red">ğŸ”´ <strong>å®Œæ•´çº åå·²è§¦å‘</strong><br>è¯·å‰å¾€ã€Œçº åã€æ ‡ç­¾å®Œæˆå›é¡¾è¡¨å•ã€‚</div>';
  } else if (consecYellow >= 2) {
    html = '<div class="alert-box yellow">ğŸŸ¡ <strong>è½»é‡çº åæç¤º</strong><br>é—®è‡ªå·±ï¼šæœ€è¿‘å“ªé‡Œæ„Ÿè§‰åœ¨èµ°å½¢å¼ï¼Ÿ<br>å†™ä¸€å¥è¯ï¼Œè°ƒæ•´ä¸€ä¸ªç»†èŠ‚ã€‚</div>';
  }
  alertEl.innerHTML = html;
}

// Steps
let stepsDone = {step1: false, step2: false, step3: false};
function toggleStep(id, item) {
  stepsDone[id] = !stepsDone[id];
  const check = document.getElementById(id);
  if (stepsDone[id]) {
    check.classList.add('done');
    check.textContent = 'âœ“';
  } else {
    check.classList.remove('done');
    check.textContent = 'ã€€';
  }
  const count = Object.values(stepsDone).filter(Boolean).length;
  document.getElementById('step-progress').style.width = (count/3*100) + '%';
  document.getElementById('step-count').textContent = count + ' / 3';
}

// Save daily
function saveDailyRecord() {
  if (!selectedLight) {
    showToast('è¯·å…ˆé€‰æ‹©ä»Šæ—¥çº¢ç»¿ç¯');
    return;
  }
  const stateWord = document.getElementById('state-word').value.trim();
  const minStep = document.getElementById('min-step').value.trim();

  const rec = {
    date: todayKey,
    color: selectedLight,
    stateWord,
    minStep,
    steps: Object.values(stepsDone).filter(Boolean).length
  };

  // Remove today if exists
  data.lights = data.lights.filter(l => l.date !== todayKey);
  data.lights.push({date: todayKey, color: selectedLight});
  data.records = data.records.filter(r => r.date !== todayKey);
  data.records.push(rec);
  save();
  showToast('è®°å½•å·²ä¿å­˜ âœ“');
  updateSignal();
}

// Signal stats
function updateSignal() {
  const all = data.lights;
  const greens = all.filter(l => l.color === 'green').length;
  const recent5 = all.slice(-7);
  const yellows = recent5.filter(l => l.color === 'yellow').length;
  const reds = recent5.filter(l => l.color === 'red').length;

  document.getElementById('stat-green').textContent = greens;
  document.getElementById('stat-yellow').textContent = yellows;
  document.getElementById('stat-red').textContent = reds;

  const pct = Math.min(greens/14*100, 100);
  document.getElementById('green-progress').style.width = pct + '%';
  document.getElementById('green-count').textContent = greens + ' / 14';

  // Status message
  const statusEl = document.getElementById('current-signal-status');
  let html = '';
  if (greens >= 14) {
    html = '<div class="alert-box green">ğŸ¯ å·²ç´¯ç§¯14ä¸ªç»¿ç¯ï¼Œå¯ä»¥åšä¸€æ¬¡æœˆåº¦æ ¡å‡†äº†ã€‚</div>';
  } else if (reds > 0) {
    html = '<div class="alert-box red">æ³¨æ„ï¼šè¿‘æœŸæœ‰çº¢ç¯ä¿¡å·ï¼Œå»ºè®®å‰å¾€ã€Œçº åã€æ ‡ç­¾ã€‚</div>';
  } else if (yellows >= 2) {
    html = '<div class="alert-box yellow">è¿‘æœŸé»„ç¯åå¤šï¼Œæ³¨æ„è½»é‡çº åã€‚</div>';
  }
  statusEl.innerHTML = html;
}

// Score
function selectScore(group, val, el) {
  el.closest('.score-row').querySelectorAll('.score-btn').forEach(b => b.classList.remove('selected'));
  el.classList.add('selected');
}

function toggleChoice(el) {
  el.classList.toggle('selected');
}

// Save review
function saveReview() {
  const step = document.getElementById('review-step').value.trim();
  const rev = {
    date: todayKey,
    step,
    timestamp: new Date().toLocaleString('zh-CN')
  };
  data.reviews.push(rev);
  save();
  showToast('çº åè®°å½•å·²ä¿å­˜ âœ“');
}

// Monthly
function saveMonthly() {
  const text = document.getElementById('monthly-review').value.trim();
  if (!text) { showToast('è¯·å…ˆå¡«å†™å›ç­”'); return; }
  data.monthly = data.monthly || [];
  data.monthly.push({date: todayKey, text});
  save();
  showToast('æœˆåº¦æ ¡å‡†å·²ä¿å­˜ âœ“');
}

// Breathing
let breathInterval = null;
function startBreath() {
  if (breathInterval) {
    clearInterval(breathInterval);
    breathInterval = null;
    document.getElementById('breath-btn').textContent = 'å¼€å§‹å‘¼å¸å¼•å¯¼';
    document.getElementById('breath-circle').style.transform = 'scale(1)';
    document.getElementById('breath-circle').textContent = 'å‡†å¤‡';
    document.getElementById('breath-text').textContent = '';
    return;
  }
  document.getElementById('breath-btn').textContent = 'åœæ­¢';
  let count = 0;
  const phases = [
    {text:'å¸æ°”â€¦', duration:4000, scale:'scale(1.3)', label:'å¸æ°” 4ç§’'},
    {text:'å‘¼æ°”â€¦', duration:6000, scale:'scale(0.8)', label:'å‘¼æ°” 6ç§’'},
  ];
  let cycle = 0;
  let totalCycles = 3;
  let phaseIdx = 0;

  function runPhase() {
    if (cycle >= totalCycles && phaseIdx === 0) {
      clearInterval(breathInterval);
      breathInterval = null;
      document.getElementById('breath-btn').textContent = 'å¼€å§‹å‘¼å¸å¼•å¯¼';
      document.getElementById('breath-circle').style.transform = 'scale(1)';
      document.getElementById('breath-circle').textContent = 'å®Œæˆ';
      document.getElementById('breath-text').textContent = 'å¾ˆå¥½ï¼Œä½ å›æ¥äº† âœ“';
      return;
    }
    const p = phases[phaseIdx];
    document.getElementById('breath-circle').style.transform = p.scale;
    document.getElementById('breath-circle').textContent = p.text;
    document.getElementById('breath-text').textContent = p.label + (phaseIdx === 0 ? `  ç¬¬ ${cycle+1} / ${totalCycles} æ¬¡` : '');

    breathInterval = setTimeout(() => {
      phaseIdx = (phaseIdx + 1) % 2;
      if (phaseIdx === 0) cycle++;
      runPhase();
    }, p.duration);
  }
  runPhase();
}

// History
function renderHistory() {
  // Dots
  const grid = document.getElementById('history-grid');
  if (data.lights.length === 0) {
    grid.innerHTML = '<p style="font-size:13px;color:var(--text-dim);">å¼€å§‹æ¯æ—¥æ‰“å¡åï¼Œå†å²è®°å½•ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œã€‚</p>';
  } else {
    const recent = data.lights.slice(-30).reverse();
    grid.innerHTML = recent.map(l => {
      const emoji = l.color === 'green' ? 'ğŸŸ¢' : l.color === 'yellow' ? 'ğŸŸ¡' : 'ğŸ”´';
      const d = l.date.slice(5);
      return `<div class="history-dot" title="${l.date}">${emoji}<span class="dot-date">${d}</span></div>`;
    }).join('');
  }

  // State words
  const stateEl = document.getElementById('state-history');
  if (data.records.length === 0) {
    stateEl.textContent = 'æš‚æ— è®°å½•';
  } else {
    stateEl.innerHTML = data.records.slice(-10).reverse().map(r =>
      `<div style="padding:6px 0;border-bottom:1px solid var(--border);">
        <span style="color:var(--text-dim);font-family:'Space Mono',monospace;font-size:11px;">${r.date}</span>
        &nbsp;
        <span style="color:var(--accent-light);">${r.stateWord || 'â€”'}</span>
        ${r.minStep ? `<br><span style="font-size:12px;color:var(--text-dim);">â†’ ${r.minStep}</span>` : ''}
      </div>`
    ).join('');
  }

  // Reviews
  const revEl = document.getElementById('review-history');
  if (!data.reviews || data.reviews.length === 0) {
    revEl.textContent = 'æš‚æ— çº åè®°å½•';
  } else {
    revEl.innerHTML = data.reviews.slice(-5).reverse().map(r =>
      `<div style="padding:8px 0;border-bottom:1px solid var(--border);">
        <span style="color:var(--red);font-family:'Space Mono',monospace;font-size:11px;">${r.timestamp}</span><br>
        <span style="color:var(--text-dim);">æœ€å°ä¸€æ­¥ï¼š${r.step || 'â€”'}</span>
      </div>`
    ).join('');
  }
}

function clearAll() {
  if (confirm('ç¡®è®¤æ¸…é™¤æ‰€æœ‰è®°å½•ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
    localStorage.removeItem('habit_data');
    data = {lights:[], records:[], reviews:[]};
    showToast('å·²æ¸…é™¤');
    renderHistory();
    updateSignal();
  }
}

// Init
updateSignal();

// Restore today's light if exists
const todayLight = data.lights.find(l => l.date === todayKey);
if (todayLight) {
  const btns = document.querySelectorAll('.light-btn');
  btns.forEach(b => {
    if (b.classList.contains(todayLight.color)) {
      b.classList.add('selected');
      selectedLight = todayLight.color;
    }
  });
}
const todayRecord = data.records.find(r => r.date === todayKey);
if (todayRecord) {
  if (todayRecord.stateWord) document.getElementById('state-word').value = todayRecord.stateWord;
  if (todayRecord.minStep) document.getElementById('min-step').value = todayRecord.minStep;
}
</script>
</body>
</html>
